<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="/assets/css/styles.css">
	<title>{{ page.title }}</title>
</head>

<body>
  <div class="title_block">
     <div id="respectthe">
	    <h1>respect the</h1>
     </div>
     <div id="boxlogo_container">
	    <img id="boxlogo" src="/assets/images/boxlogo.png">
     </div>
	{% include navigator.html %}
  </div>

  <div class="content_superblock">
     <div id="empty_block_left">
     </div>
     <div id="alltreenodes">
        <div id="tree0" class="treenode">
	    {{ content }}
        </div>
     </div>
  </div>
</body>

<script>
// ###################################################
// SCROLLING HELPERS
// ###################################################
var target_top;
var target_top_eff;
var limit_seen;
var clicked_treelevel;

function scroll_curve(total, fractiondone) {
	var direction = Math.sign(total);
	total = Math.abs(total);
	sofar = Math.abs(fractiondone);
	var magnitude = Math.max(total/30, 1)
	var delta = direction * ( magnitude*Math.pow(2, -1*Math.pow(4*fractiondone-2, 2)) + 1 );
	return delta;
}

function smooth_scroll(begPos, tgtPos) {
	if(Math.abs(tgtPos - window.pageYOffset) < 5) {
		return;
	}
	var total = tgtPos - begPos;
	var delta = scroll_curve(total, (window.pageYOffset - begPos)/total);
	window.scrollTo(0, window.pageYOffset + delta);
	setTimeout(function() {smooth_scroll(begPos, tgtPos);}, 10);
}

function start_smooth_scroll(tgtElem) {
	var tgtPos = window.pageYOffset + tgtElem.getBoundingClientRect().top;
	target_top = tgtPos;
	var limit = Math.max( document.body.scrollHeight, document.body.offsetHeight, 
		document.documentElement.clientHeight, document.documentElement.scrollHeight, 
		document.documentElement.offsetHeight) - window.innerHeight;
	limit_seen = limit;
	if (tgtPos >= limit) {
		tgtPos = limit;
	}
	target_top_eff = tgtPos;
	smooth_scroll(window.pageYOffset, tgtPos);
}
// ###################################################


// ###################################################
// HELPERS FOR INSERTING NEW DIVS IN TOPIC TREE
// ###################################################
var targeted_div;

function insertAfter(newElement, referenceElement) {
	referenceElement.parentElement.insertBefore(newElement, referenceElement.nextSibling);
} 

function getNumberOfNodes() {
	return document.getElementsByClassName("treenode").length;
}

function remove_nodes_under_clicked_node() {
	var nodes = document.getElementsByClassName("treenode");
	var i;
	for (i=getNumberOfNodes()-1; i>clicked_treelevel; i--) {
		nodes[i].remove();
	}
}

function get_clicked_treelevel(linkclicked) {
	var linkclass = linkclicked.getAttribute("class");
	var level = parseInt(linkclass.substring(11, linkclass.length));
	return level;	
}

function armLinksWithLocation(newNode, treelevel) {
	var links = newNode.getElementsByTagName("a");
	var i;
	for (i=0; i<links.length; i++) {
		links[i].setAttribute("class", "link_atnode" + treelevel.toString(10));
	}
	return;
}

function changeTreeNode(topicfile, linkclicked) {
	var target_div, xhttp;
	clicked_treelevel = get_clicked_treelevel(linkclicked);
	remove_nodes_under_clicked_node();
	target_div = document.createElement("div");
	target_div.setAttribute("id", "tree" + (clicked_treelevel + 1));
	target_div.setAttribute("class", "treenode");
	insertAfter(target_div, document.getElementById("tree" + clicked_treelevel.toString(10)));
	xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4) {
			if(this.status == 200) {
				target_div.innerHTML = this.responseText;
				armLinksWithLocation(target_div, clicked_treelevel + 1);
				start_smooth_scroll(target_div);
				targeted_div = target_div;
			}
		}
	}
	xhttp.open("GET", topicfile, true);
	xhttp.send();
 
	return;
}
// ###################################################

</script>

</html>
